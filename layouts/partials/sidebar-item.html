<!--
  SIDEBAR ITEM PARTIAL (layouts/partials/sidebar-item.html)
  PURPOSE: Recursive component for rendering expandable sidebar sections
  
  RECURSION:
  - Supports unlimited nesting depth
  - Calls itself for child items
  - Each level indents by default padding
  - Manages level numbers for styling (level-0, level-1, etc.)
  
  FEATURES:
  - Section title with chevron toggle button
  - Click title to navigate AND expand/collapse
  - Shows/hides child items with smooth animation
  - Highlights active page
  - Auto-expands ancestors of active page
  - Keyboard accessible with aria-expanded
  
  INPUTS (from sidebar.html):
  - item: Section data object with title, slug, pages array
  - currentPath: Current page path for active detection
  - level: Nesting depth (0 = root)
  - basePath: Parent path for building child URLs
  
  RENDERING:
  - .nav-section: Container for section
  - .nav-section__link: Clickable title
  - .nav-section__toggle: Chevron icon (aria-expanded)
  - .nav-section__items: Child items container
  - Recursive call for nested items
  
  RELATED FILES:
  - partials/sidebar.html: Parent template
  - js/sidebar.js: Toggle/click handling
  - css/sidebar.css: Styling and animations
-->
{{/* Recursive sidebar item partial */}}
{{- $item := .item -}}
{{- $currentPath := .currentPath -}}
{{- $level := .level | default 0 -}}
{{- $basePath := .basePath | default "" -}}

{{/* Build the full path for this item */}}
{{- $itemPath := "" -}}
{{- if $item.path -}}
  {{- $itemPath = $item.path -}}
{{- else if $item.slug -}}
  {{- if $basePath -}}
    {{- $itemPath = printf "%s/%s" $basePath $item.slug -}}
  {{- else -}}
    {{- $itemPath = $item.slug -}}
  {{- end -}}
{{- end -}}

{{/* Check if this item or any descendant is active */}}
{{- $isActive := false -}}
{{- $hasActiveDescendant := false -}}

{{- if $itemPath -}}
  {{- $isActive = eq $currentPath $itemPath -}}
  {{- $hasActiveDescendant = and (not $isActive) (hasPrefix $currentPath $itemPath) -}}
{{- end -}}

{{- $hasChildren := isset $item "pages" -}}
{{- $isExpanded := or $isActive $hasActiveDescendant -}}
{{- $href := printf "docs/%s/" $itemPath | absURL -}}

{{- if $hasChildren -}}
  {{/* Section with children - title is a link, chevron toggles expand */}}
  <div class="nav-section nav-section--level-{{ $level }}{{ if $isExpanded }} has-active{{ end }}{{ if $isActive }} is-active{{ end }}" data-level="{{ $level }}">
    <div class="nav-section__header">
      <a href="{{ $href }}" class="nav-section__link{{ if $isActive }} active{{ end }}">
        <span class="nav-section__title">{{ $item.title }}</span>
      </a>
      <button class="nav-section__toggle" aria-expanded="{{ if $isExpanded }}true{{ else }}false{{ end }}" aria-label="Toggle {{ $item.title }}">
        <svg class="nav-section__chevron" width="16" height="16" viewBox="0 0 16 16" fill="none">
          <path d="M6 12L10 8L6 4" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
        </svg>
      </button>
    </div>
    
    <ul class="nav-section__items{{ if $isExpanded }} expanded{{ end }}">
      {{- range $child := $item.pages -}}
        <li class="nav-section__item">
          {{- partial "sidebar-item.html" (dict "item" $child "currentPath" $currentPath "level" (add $level 1) "basePath" $itemPath) -}}
        </li>
      {{- end -}}
    </ul>
  </div>
{{- else -}}
  {{/* Leaf node - just a link */}}
  <a href="{{ $href }}" class="nav-link nav-link--level-{{ $level }}{{ if $isActive }} active{{ end }}">
    {{ $item.title }}
  </a>
{{- end -}}
